spriteset(spriteset_BR357_Purchase, "gfx/EMU/357.png") { template_purchase(200, 75)}

spriteset(spriteset_BR357_front_C2CWhite, "gfx/EMU/357.png") { template_train32px(0, 0) }
spriteset(spriteset_BR357_rear_C2CWhite, "gfx/EMU/357.png") { template_train32px(0, 26) }
spriteset(spriteset_BR357_middle_C2CWhite, "gfx/EMU/357.png") { template_train32px(0, 52) }
spriteset(spriteset_BR357_middlePanto_C2CWhite, "gfx/EMU/357.png") { template_train32px(0, 78) }
spriteset(spriteset_BR357_front_C2CWhite_reversed, "gfx/EMU/357.png") { template_train32px_reversed(200, 0) }
spriteset(spriteset_BR357_rear_C2CWhite_reversed, "gfx/EMU/357.png") { template_train32px_reversed(200, 26) }
spriteset(spriteset_BR357_middle_C2CWhite_reversed, "gfx/EMU/357.png") { template_train32px_reversed(0, 52) }
spriteset(spriteset_BR357_middlePanto_C2CWhite_reversed, "gfx/EMU/357.png") { template_train32px_reversed(0, 78) }

spriteset(spriteset_BR357_front_C2CBlue, "gfx/EMU/357.png") { template_train32px(0, 104) }
spriteset(spriteset_BR357_rear_C2CBlue, "gfx/EMU/357.png") { template_train32px(0, 130) }
spriteset(spriteset_BR357_middle_C2CBlue, "gfx/EMU/357.png") { template_train32px(0, 156) }
spriteset(spriteset_BR357_middlePanto_C2CBlue, "gfx/EMU/357.png") { template_train32px(0, 182) }
spriteset(spriteset_BR357_front_C2CBlue_reversed, "gfx/EMU/357.png") { template_train32px_reversed(200, 104) }
spriteset(spriteset_BR357_rear_C2CBlue_reversed, "gfx/EMU/357.png") { template_train32px_reversed(200, 130) }
spriteset(spriteset_BR357_middle_C2CBlue_reversed, "gfx/EMU/357.png") { template_train32px_reversed(0, 156) }
spriteset(spriteset_BR357_middlePanto_C2CBlue_reversed, "gfx/EMU/357.png") { template_train32px_reversed(0, 182) }

spriteset(spriteset_BR357_front_LTS, "gfx/EMU/357.png") { template_train32px(0, 208) }
spriteset(spriteset_BR357_rear_LTS, "gfx/EMU/357.png") { template_train32px(0, 234) }
spriteset(spriteset_BR357_middle_LTS, "gfx/EMU/357.png") { template_train32px(0, 260) }
spriteset(spriteset_BR357_middlePanto_LTS, "gfx/EMU/357.png") { template_train32px(0, 286) }
spriteset(spriteset_BR357_front_LTS_reversed, "gfx/EMU/357.png") { template_train32px_reversed(200, 208) }
spriteset(spriteset_BR357_rear_LTS_reversed, "gfx/EMU/357.png") { template_train32px_reversed(200, 234) }
spriteset(spriteset_BR357_middle_LTS_reversed, "gfx/EMU/357.png") { template_train32px_reversed(0, 260) }
spriteset(spriteset_BR357_middlePanto_LTS_reversed, "gfx/EMU/357.png") { template_train32px_reversed(0, 286) }

spriteset(spriteset_BR357_front_C2CPink, "gfx/EMU/357.png") { template_train32px(0, 312) }
spriteset(spriteset_BR357_rear_C2CPink, "gfx/EMU/357.png") { template_train32px(0, 338) }
spriteset(spriteset_BR357_middle_C2CPink, "gfx/EMU/357.png") { template_train32px(0, 364) }
spriteset(spriteset_BR357_middlePanto_C2CPink, "gfx/EMU/357.png") { template_train32px(0, 390) }
spriteset(spriteset_BR357_front_C2CPink_reversed, "gfx/EMU/357.png") { template_train32px_reversed(200, 312) }
spriteset(spriteset_BR357_rear_C2CPink_reversed, "gfx/EMU/357.png") { template_train32px_reversed(200, 338) }
spriteset(spriteset_BR357_middle_C2CPink_reversed, "gfx/EMU/357.png") { template_train32px_reversed(0, 364) }
spriteset(spriteset_BR357_middlePanto_C2CPink_reversed, "gfx/EMU/357.png") { template_train32px_reversed(0, 390) }

spriteset(spriteset_BR357_front_C2CGoGold, "gfx/EMU/357.png") { template_train32px(0, 416) }
spriteset(spriteset_BR357_rear_C2CGoGold, "gfx/EMU/357.png") { template_train32px(0, 442) }
spriteset(spriteset_BR357_middle_C2CGoGold, "gfx/EMU/357.png") { template_train32px(0, 468) }
spriteset(spriteset_BR357_middlePanto_C2CGoGold, "gfx/EMU/357.png") { template_train32px(0, 494) }
spriteset(spriteset_BR357_front_C2CGoGold_reversed, "gfx/EMU/357.png") { template_train32px_reversed(200, 416) }
spriteset(spriteset_BR357_rear_C2CGoGold_reversed, "gfx/EMU/357.png") { template_train32px_reversed(200, 442) }
spriteset(spriteset_BR357_middle_C2CGoGold_reversed, "gfx/EMU/357.png") { template_train32px_reversed(0, 468) }
spriteset(spriteset_BR357_middlePanto_C2CGoGold_reversed, "gfx/EMU/357.png") { template_train32px_reversed(0, 494) }

spriteset(spriteset_BR357_front_C2CGreen, "gfx/EMU/357.png") { template_train32px(0, 520) }
spriteset(spriteset_BR357_rear_C2CGreen, "gfx/EMU/357.png") { template_train32px(0, 546) }
spriteset(spriteset_BR357_middle_C2CGreen, "gfx/EMU/357.png") { template_train32px(0, 572) }
spriteset(spriteset_BR357_middlePanto_C2CGreen, "gfx/EMU/357.png") { template_train32px(0, 598) }
spriteset(spriteset_BR357_front_C2CGreen_reversed, "gfx/EMU/357.png") { template_train32px_reversed(200, 520) }
spriteset(spriteset_BR357_rear_C2CGreen_reversed, "gfx/EMU/357.png") { template_train32px_reversed(200, 546) }
spriteset(spriteset_BR357_middle_C2CGreen_reversed, "gfx/EMU/357.png") { template_train32px_reversed(0, 572) }
spriteset(spriteset_BR357_middlePanto_C2CGreen_reversed, "gfx/EMU/357.png") { template_train32px_reversed(0, 598) }

// Stage 1: map livery subtype to role sprites (a=front, b=middle, c=middlePanto, d=rear).
switch(FEAT_TRAINS, SELF, sw_BR357_a, cargo_subtype) {
	0: spriteset_BR357_front_C2CWhite;
	1: spriteset_BR357_front_C2CBlue;
	2: spriteset_BR357_front_C2CGoGold;
	3: spriteset_BR357_front_C2CPink;
	4: spriteset_BR357_front_C2CGreen;
	5: spriteset_BR357_front_LTS;
	default: spriteset_BR357_front_C2CWhite;
}

switch(FEAT_TRAINS, SELF, sw_BR357_b, cargo_subtype) {
	0: spriteset_BR357_middle_C2CWhite;
	1: spriteset_BR357_middle_C2CBlue;
	2: spriteset_BR357_middle_C2CGoGold;
	3: spriteset_BR357_middle_C2CPink;
	4: spriteset_BR357_middle_C2CGreen;
	5: spriteset_BR357_middle_LTS;
	default: spriteset_BR357_middle_C2CWhite;
}

switch(FEAT_TRAINS, SELF, sw_BR357_c, cargo_subtype) {
	0: spriteset_BR357_middlePanto_C2CWhite;
	1: spriteset_BR357_middlePanto_C2CBlue;
	2: spriteset_BR357_middlePanto_C2CGoGold;
	3: spriteset_BR357_middlePanto_C2CPink;
	4: spriteset_BR357_middlePanto_C2CGreen;
	5: spriteset_BR357_middlePanto_LTS;
	default: spriteset_BR357_middlePanto_C2CWhite;
}

switch(FEAT_TRAINS, SELF, sw_BR357_d, cargo_subtype) {
	0: spriteset_BR357_rear_C2CWhite;
	1: spriteset_BR357_rear_C2CBlue;
	2: spriteset_BR357_rear_C2CGoGold;
	3: spriteset_BR357_rear_C2CPink;
	4: spriteset_BR357_rear_C2CGreen;
	5: spriteset_BR357_rear_LTS;
	default: spriteset_BR357_rear_C2CWhite;
}

// Stage 2 (reversed): choose reversed livery using mirrored vehicle cargo subtype (var 0xF2).
switch(FEAT_TRAINS, SELF, sw_BR357_a_rev, [STORE_TEMP(position_in_consist_from_end-position_in_consist, 0x10F), var[0x61, 0, 0x0000FFFF, 0xF2]]) {
	0: spriteset_BR357_front_C2CWhite_reversed;
	1: spriteset_BR357_front_C2CBlue_reversed;
	2: spriteset_BR357_front_C2CGoGold_reversed;
	3: spriteset_BR357_front_C2CPink_reversed;
	4: spriteset_BR357_front_C2CGreen_reversed;
	5: spriteset_BR357_front_LTS_reversed;
	default: spriteset_BR357_front_C2CWhite_reversed;
}

switch(FEAT_TRAINS, SELF, sw_BR357_b_rev, [STORE_TEMP(position_in_consist_from_end-position_in_consist, 0x10F), var[0x61, 0, 0x0000FFFF, 0xF2]]) {
	0: spriteset_BR357_middle_C2CWhite_reversed;
	1: spriteset_BR357_middle_C2CBlue_reversed;
	2: spriteset_BR357_middle_C2CGoGold_reversed;
	3: spriteset_BR357_middle_C2CPink_reversed;
	4: spriteset_BR357_middle_C2CGreen_reversed;
	5: spriteset_BR357_middle_LTS_reversed;
	default: spriteset_BR357_middle_C2CWhite_reversed;
}

switch(FEAT_TRAINS, SELF, sw_BR357_c_rev, [STORE_TEMP(position_in_consist_from_end-position_in_consist, 0x10F), var[0x61, 0, 0x0000FFFF, 0xF2]]) {
	0: spriteset_BR357_middlePanto_C2CWhite_reversed;
	1: spriteset_BR357_middlePanto_C2CBlue_reversed;
	2: spriteset_BR357_middlePanto_C2CGoGold_reversed;
	3: spriteset_BR357_middlePanto_C2CPink_reversed;
	4: spriteset_BR357_middlePanto_C2CGreen_reversed;
	5: spriteset_BR357_middlePanto_LTS_reversed;
	default: spriteset_BR357_middlePanto_C2CWhite_reversed;
}

switch(FEAT_TRAINS, SELF, sw_BR357_d_rev, [STORE_TEMP(position_in_consist_from_end-position_in_consist, 0x10F), var[0x61, 0, 0x0000FFFF, 0xF2]]) {
	0: spriteset_BR357_rear_C2CWhite_reversed;
	1: spriteset_BR357_rear_C2CBlue_reversed;
	2: spriteset_BR357_rear_C2CGoGold_reversed;
	3: spriteset_BR357_rear_C2CPink_reversed;
	4: spriteset_BR357_rear_C2CGreen_reversed;
	5: spriteset_BR357_rear_LTS_reversed;
	default: spriteset_BR357_rear_C2CWhite_reversed;
}

// Stage 3: map each vehicle_type_id to its role switch; includes mirrored IDs (+2000).
switch(FEAT_TRAINS, SELF, sw_BR357_role_from_vehicle, vehicle_type_id) {
	600: sw_BR357_a;
	601: sw_BR357_a;
	602: sw_BR357_a;
	2600: sw_BR357_a;
	2601: sw_BR357_a;
	2602: sw_BR357_a;
	603: sw_BR357_b;
	606: sw_BR357_b;
	609: sw_BR357_b;
	2603: sw_BR357_b;
	2606: sw_BR357_b;
	2609: sw_BR357_b;
	604: sw_BR357_c;
	607: sw_BR357_c;
	610: sw_BR357_c;
	2604: sw_BR357_c;
	2607: sw_BR357_c;
	2610: sw_BR357_c;
	605: sw_BR357_d;
	608: sw_BR357_d;
	611: sw_BR357_d;
	2605: sw_BR357_d;
	2608: sw_BR357_d;
	2611: sw_BR357_d;
	default: sw_BR357_a;
}

// Stage 4: in reversed mode, use mirrored vehicle_type_id (var 0xC6) to keep car roles stable in full consists.
switch(FEAT_TRAINS, SELF, sw_BR357_rev_from_mirror, [STORE_TEMP(position_in_consist_from_end-position_in_consist, 0x10F), var[0x61, 0, 0x0000FFFF, 0xC6]]) {
	600: sw_BR357_a_rev;
	601: sw_BR357_a_rev;
	602: sw_BR357_a_rev;
	2600: sw_BR357_a_rev;
	2601: sw_BR357_a_rev;
	2602: sw_BR357_a_rev;
	603: sw_BR357_b_rev;
	606: sw_BR357_b_rev;
	609: sw_BR357_b_rev;
	2603: sw_BR357_b_rev;
	2606: sw_BR357_b_rev;
	2609: sw_BR357_b_rev;
	604: sw_BR357_c_rev;
	607: sw_BR357_c_rev;
	610: sw_BR357_c_rev;
	2604: sw_BR357_c_rev;
	2607: sw_BR357_c_rev;
	2610: sw_BR357_c_rev;
	605: sw_BR357_d_rev;
	608: sw_BR357_d_rev;
	611: sw_BR357_d_rev;
	2605: sw_BR357_d_rev;
	2608: sw_BR357_d_rev;
	2611: sw_BR357_d_rev;
	default: sw_BR357_a_rev;
}

// Final selector: normal role mapping when not reversed, mirrored-role mapping when reversed.
switch(FEAT_TRAINS, PARENT, sw_BR357_pushpull, vehicle_is_reversed) {
	0: sw_BR357_role_from_vehicle;
	1: sw_BR357_rev_from_mirror;
}
