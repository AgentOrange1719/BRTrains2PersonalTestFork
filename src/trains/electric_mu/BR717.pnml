spriteset(spriteset_BR717_Purchase, "gfx/EMU/Desiro_City_WIP.png") {template_purchase(200, 13)}

// Forward sprites (car roles in a 6-car Class 717 unit).
spriteset(spriteset_BR717_front_GTR, "gfx/EMU/Desiro_City_WIP.png") { template_train32px_old(0, 0) }
spriteset(spriteset_BR717_middle_GTR, "gfx/EMU/Desiro_City_WIP.png") { template_train32px_old(0, 50) }
spriteset(spriteset_BR717_middle_access_GTR, "gfx/EMU/Desiro_City_WIP.png") { template_train32px_old(0, 75) }
spriteset(spriteset_BR717_panto_GTR, "gfx/EMU/Desiro_City_WIP.png") { template_train32px_old(0, 100) }
spriteset(spriteset_BR717_rear_GTR, "gfx/EMU/Desiro_City_WIP.png") { template_train32px_old(0, 125) }

// Reversed sprites for push-pull direction changes.
spriteset(spriteset_BR717_front_GTR_rev, "gfx/EMU/Desiro_City_WIP.png") { template_train32px_old_reversed(0, 25) }
spriteset(spriteset_BR717_middle_GTR_rev, "gfx/EMU/Desiro_City_WIP.png") { template_train32px_old_reversed(0, 50) }
spriteset(spriteset_BR717_middle_access_GTR_rev, "gfx/EMU/Desiro_City_WIP.png") { template_train32px_old_reversed(0, 75) }
spriteset(spriteset_BR717_panto_GTR_rev, "gfx/EMU/Desiro_City_WIP.png") { template_train32px_old_reversed(0, 100) }
spriteset(spriteset_BR717_rear_GTR_rev, "gfx/EMU/Desiro_City_WIP.png") { template_train32px_old_reversed(0, 150) }

// Class 717 graphics + selector flow (single articulated item ID).
//
// Runtime call order is:
// Step 1: switch_BR717_spriteset
//   -> Step 2: switch_BR717_direction
//      -> Step 3: switch_BR717_roles_fwd (if not reversed), or
//      -> Step 4: switch_BR717_roles_rev (if reversed).

// Step 3 (forward path): choose car role by articulated position within each 6-car set.
// Order is front, middle, middle_access, middle, panto, rear.
switch(FEAT_TRAINS, SELF, switch_BR717_roles_fwd, position_in_articulated_veh % 6) {
	0: spriteset_BR717_front_GTR;
	1: spriteset_BR717_middle_GTR;
	2: spriteset_BR717_middle_access_GTR;
	3: spriteset_BR717_middle_GTR;
	4: spriteset_BR717_panto_GTR;
	5: spriteset_BR717_rear_GTR;
	spriteset_BR717_middle_GTR;
}

// Step 4 (reversed path): mirror role selection by consist-from-end position.
// This keeps units visually fixed when reversing, including multiple coupled units.
switch(FEAT_TRAINS, SELF, switch_BR717_roles_rev, position_in_consist_from_end % 6) {
	0: spriteset_BR717_front_GTR_rev;
	1: spriteset_BR717_middle_GTR_rev;
	2: spriteset_BR717_middle_access_GTR_rev;
	3: spriteset_BR717_middle_GTR_rev;
	4: spriteset_BR717_panto_GTR_rev;
	5: spriteset_BR717_rear_GTR_rev;
	spriteset_BR717_middle_GTR_rev;
}

// Step 2: direction gate chooses forward or reversed role path.
switch(FEAT_TRAINS, PARENT, switch_BR717_direction, vehicle_is_reversed) {
	1: switch_BR717_roles_rev;
	switch_BR717_roles_fwd;
}

// Step 1: top-level selector called by item_BR717 graphics.default.
// Currently only one livery, but keeping this as an entry point allows easy extension.
switch(FEAT_TRAINS, SELF, switch_BR717_spriteset, cargo_subtype) {
	0: switch_BR717_direction;
	switch_BR717_direction;
}

// Build a fixed 6-car articulated unit from one item ID.
switch(FEAT_TRAINS, SELF, switch_articulated_BR717, extra_callback_info1) {
	1..5: return item_BR717;
	return CB_RESULT_NO_MORE_ARTICULATED_PARTS;
}

// Only the panto car (index 4) should emit electric effects.
switch(FEAT_TRAINS, SELF, switch_BR717_particles, position_in_articulated_veh % 6) {
	4: visual_effect_and_powered(VISUAL_EFFECT_ELECTRIC, 2, DISABLE_WAGON_POWER);
	visual_effect_and_powered(VISUAL_EFFECT_DISABLE, 0, DISABLE_WAGON_POWER);
}

switch(FEAT_TRAINS, SELF, switch_BR717_start_stop, num_vehs_in_consist) {
	return CB_RESULT_NO_TEXT;
}

// Per-car capacity split for seat-based mode.
// Total base seats = 61 + 60 + 60 + 60 + 60 + 61 = 362.
switch(FEAT_TRAINS, SELF, switch_BR717_cargo_capacity_seated, position_in_consist % 6) {
	0: return(61 * param_pax);
	5: return(61 * param_pax);
	return(60 * param_pax);
}

// Per-car capacity split for high-capacity mode (seat + standing room).
// Total base capacity = 157 + 157 + 157 + 157 + 157 + 158 = 943.
switch(FEAT_TRAINS, SELF, switch_BR717_cargo_capacity_high, position_in_consist % 6) {
	5: return(158 * param_pax);
	return(157 * param_pax);
}

// Select seated or high-capacity split from GRF-wide parameter.
// This happens before the global param_pax multiplier used in each branch.
switch(FEAT_TRAINS, SELF, switch_BR717_cargo_capacity, param_standing_capacity) {
	1: switch_BR717_cargo_capacity_high;
	switch_BR717_cargo_capacity_seated;
}

// Only allow Class 717 units to couple with Class 717 units.
switch(FEAT_TRAINS, SELF, switch_BR717_can_attach_wagon, vehicle_type_id) {
	item_BR717: return CB_RESULT_ATTACH_ALLOW;
	return string(STR_CANNOT_ATTACH);
}

switch(FEAT_TRAINS, SELF, sw_BR717_cargo_subtype_text, cargo_subtype) {
	0: return string(str_GreatNorthern);
	return CB_RESULT_NO_TEXT;
}

// Purchase text helper: show exact total capacity by current mode and pax multiplier.
// The purchase list capacity column still rounds from per-car values for articulated units.
switch(FEAT_TRAINS, SELF, switch_BR717_additional_text, param_standing_capacity * 10 + param_pax) {
	1: return(string(str_purchase_loco_with_liveries_and_capacity,
			string(str_purchase_type_emu),
			string(str_BR717_usage),
			string(str_BR717_eos),
			string(str_BR717_capacity_1x),
			string(str_BR717_liveries)));
	2: return(string(str_purchase_loco_with_liveries_and_capacity,
			string(str_purchase_type_emu),
			string(str_BR717_usage),
			string(str_BR717_eos),
			string(str_BR717_capacity_2x),
			string(str_BR717_liveries)));
	3: return(string(str_purchase_loco_with_liveries_and_capacity,
			string(str_purchase_type_emu),
			string(str_BR717_usage),
			string(str_BR717_eos),
			string(str_BR717_capacity_3x),
			string(str_BR717_liveries)));
	4: return(string(str_purchase_loco_with_liveries_and_capacity,
			string(str_purchase_type_emu),
			string(str_BR717_usage),
			string(str_BR717_eos),
			string(str_BR717_capacity_4x),
			string(str_BR717_liveries)));
	11: return(string(str_purchase_loco_with_liveries_and_capacity,
			string(str_purchase_type_emu),
			string(str_BR717_usage),
			string(str_BR717_eos),
			string(str_BR717_capacity_hc_1x),
			string(str_BR717_liveries)));
	12: return(string(str_purchase_loco_with_liveries_and_capacity,
			string(str_purchase_type_emu),
			string(str_BR717_usage),
			string(str_BR717_eos),
			string(str_BR717_capacity_hc_2x),
			string(str_BR717_liveries)));
	13: return(string(str_purchase_loco_with_liveries_and_capacity,
			string(str_purchase_type_emu),
			string(str_BR717_usage),
			string(str_BR717_eos),
			string(str_BR717_capacity_hc_3x),
			string(str_BR717_liveries)));
	14: return(string(str_purchase_loco_with_liveries_and_capacity,
			string(str_purchase_type_emu),
			string(str_BR717_usage),
			string(str_BR717_eos),
			string(str_BR717_capacity_hc_4x),
			string(str_BR717_liveries)));
	return(string(str_purchase_loco_with_liveries_and_capacity,
			string(str_purchase_type_emu),
			string(str_BR717_usage),
			string(str_BR717_eos),
			string(str_BR717_capacity_1x),
			string(str_BR717_liveries)));
}

item(FEAT_TRAINS, item_BR717, 518) {
	property {
		variant_group:					header_DesiroCity;
		name: 							string(STR_NAME_BR717);
		climates_available: 			ALL_CLIMATES;
		introduction_date:				date(2015,4,21);
		model_life:						15;
		retire_early:					1;
		vehicle_life:					50;
		reliability_decay:				7;
		refittable_cargo_classes:		CC_PASSENGERS;
		cargo_allow_refit:				[PASS, TOUR];
		loading_speed:					25;
		cost_factor:					123;
		running_cost_factor:			70;
		sprite_id:						SPRITE_ID_NEW_TRAIN;
		speed:							100 mph;
		refit_cost:						0;
		track_type:						[THIRD, THIRD, ELRL];
		ai_special_flag:				AI_FLAG_CARGO;
		power:							3300 hp;
		running_cost_base:				RUNNING_COST_ELECTRIC;
		misc_flags:						TRAIN_FLAG_MU;
		dual_headed:					0;
		default_cargo_type:				PASS;
		cargo_capacity:					60;
		weight:							306 ton;
		engine_class:					ENGINE_CLASS_ELECTRIC;
		tractive_effort_coefficient:	0.15;
		air_drag_coefficient:			0.05;
		length:							8;
		visual_effect_and_powered:		visual_effect_and_powered(VISUAL_EFFECT_ELECTRIC, 2, DISABLE_WAGON_POWER);
		extra_weight_per_wagon:			0;
		bitmask_vehicle_info:			0;
	}

	graphics {
		additional_text:				switch_BR717_additional_text;
		can_attach_wagon:				switch_BR717_can_attach_wagon;
		cargo_subtype_text:				sw_BR717_cargo_subtype_text;
		articulated_part:				switch_articulated_BR717;
		start_stop:						switch_BR717_start_stop;
		default: 						switch_BR717_spriteset;
		purchase:						spriteset_BR717_Purchase;
		visual_effect_and_powered:		switch_BR717_particles;
		colour_mapping: 				return PALETTE_CC_FIRST;
		sound_effect:					sw_sound_electric_350;
		cargo_capacity:					switch_BR717_cargo_capacity;
		cost_factor:					return(GetAdjustedCost(123));
		running_cost_factor:			return(GetAdjustedCost(70));
	}
}
